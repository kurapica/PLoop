# DependencyInjection

The dependency injection system require one platform settings to be enabled: `ENABLE_ARGUMENTS_ATTACHMENT`, so the system can figure out how to generate the instance based on the arguments settings of constructors and methods.

The system support constructor injection, object method injection, static method injection, module function injection and property injection.


## Table of Contents

* [Build The Service Provider](#build-the-service-provider)
* [Constructor Injection](#constructor-injection)
* [Module Function Injection](#module-function-injection)
* [Object Method Injection](#object-method-injection)
* [Static Method Injection](#static-method-injection)
* [Property Injection](#property-injection)


## Build The Service Provider

Save the code below as `provider.lua` to be used in other examples:

```lua
PLOOP_PLATFORM_SETTINGS = {
    ENABLE_ARGUMENTS_ATTACHMENT = true
}

local provider

require "PLoop" (function(_ENV)
    import "System.DependencyInjection"

    -- Use struct for config
    struct "AppConfig" {
        name = { type = String, require = true },
        jwt = { require = true, type = {
                key = Guid,
                expireTime = NaturalNumber,
            }
        },
        port = NaturalNumber,
    }

    -- Declare the service
    interface "IAppService" {}

    -- Implement the service
    class "AppService" (function(_ENV)
        extend "IAppService" "IAutoClose"

        function Open(self)
            print("[Open] AppService", self)
        end

        function Close(self)
            print("[Close] AppService", self)
        end

        property "Config" { type = AppConfig }

        __Arguments__{ AppConfig }
        function __ctor(self, config)
            self.Config = config
        end
    end)

    -- Build the service collection
    services = ServiceCollection()

    services:AddSingleton(AppConfig, {
        name = "Test",
        jwt = {
            key = Guid.New(),
            expireTime = 60,
        },
        port = 5555
    })

    services:AddScoped(IAppService, AppService)

    -- Build the service provider
    provider = services:BuildServiceProvider()
end)

return provider
```


## Constructor Injection

Here is a simple usage of the dependency injection system:

```lua
local provider = require "provider"

PLoop(function(_ENV)
    with(provider:CreateScope())(function(scope)
        local app = scope.ServiceProvider:GetService(IAppService)
        print(app.Config.jwt.key)
        app.Config.port = 666

        app = scope.ServiceProvider:GetService(IAppService)
        print(app.Config.port)
    end)
end)
```

The result will be

    [Open] AppService   table: 01118E58
    42D308D9-AFC9-23CF-1197-5D83E15BA8E3
    666
    [Close] AppService  table: 01118E58

So a new app service is created in the scope, it'll be auto open when it's created and auto close when the scope is closed.



## Module Function Injection

We can declare module function with `__Arguments__`, they can be processed by the service provider:

```lua
local provider = require "provider"

print(provider)

PLoop(function(_ENV)
    __Arguments__{ IAppService }
    function TestApp(app)
        return app.Config.jwt.key
    end

    with(provider:CreateScope())(function(scope)
        print( scope.ServiceProvider:CallMethod(TestApp) )
    end)
end)
```

The result will be

    [Open] AppService   table: 01489E60
    5B63E9CF-AFC3-52A7-32A7-C40359B1A1B9
    [Close] AppService  table: 01489E60



## Object Method Injection

We also can process the object method by service provider like

```lua
local provider = require "provider"

PLoop(function(_ENV)
    class "TestCase" (function(_ENV)
        __Arguments__{ IAppService }
        function TestApp(self, app)
            return app.Config.jwt.key
        end
    end)

    with(provider:CreateScope())(function(scope)
        case = TestCase()

        print( scope.ServiceProvider:CallMethod(case, "TestApp") )
    end)
end)
```

The result will be

    [Open] AppService   table: 01212B20
    5E53A295-6199-C609-65A7-8BEF46095BBF
    [Close] AppService  table: 01212B20


## Static Method Injection

Besides the object method, static method is also supported:

```lua
local provider = require "provider"

PLoop(function(_ENV)
    class "TestCase" (function(_ENV)
        __Static__() __Arguments__{ IAppService }
        function TestApp(app)
            return app.Config.jwt.key
        end
    end)

    with(provider:CreateScope())(function(scope)
        print( scope.ServiceProvider:CallMethod(TestCase, "TestApp") )
    end)
end)
```

The result will be

    [Open] AppService   table: 00FF1C30
    5F8D613B-8CAB-05C7-819D-4C75D5331205
    [Close] AppService  table: 00FF1C30



## Property Injection

If an object is generated by the service provider, it can have auto injection properties:

```lua
local provider = require "provider"

PLoop(function(_ENV)
    import "System.DependencyInjection"

    --- Redefine the service
    class "AppService" (function(_ENV)
        __AutoInjection__()
        property "AutoConfig" { type = AppConfig }
    end)

    with(provider:CreateScope())(function(scope)
        local service = scope.ServiceProvider:GetService(IAppService)
        print(service.AutoConfig.jwt.key)
    end)
end)
```

The result will be

    [Open] AppService   table: 014097A0
    649953AD-7E4F-6CB7-D4F9-069FA3C761E3
    [Close] AppService  table: 014097A0